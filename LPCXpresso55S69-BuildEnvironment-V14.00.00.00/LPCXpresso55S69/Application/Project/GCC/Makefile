###############################################################################
# Makefile for Embedded Wizard GUI Application
###############################################################################
export MAKEFLAGS += --silent

###############################################################################
# GENERAL PROJECT CONFIGURATION
###############################################################################
APP_FILE          = EmbeddedWizard-LPCXpresso55S69

FREE_RTOS        ?= 1
# REMARK: Set the macro FREE_RTOS to 1 to build an Embedded Wizard project
# based on FreeRTOS.

###############################################################################
# GENERAL SETTINGS & PATHS
###############################################################################
EMWI_APP_PATH     = ../../GeneratedCode

SRC_PATH          = ../../Source
EMWI_BSP_PATH     = ../../../TargetSpecific

OBJ_PATH          = ./Obj
BIN_PATH          = ./Bin

SDK_PATH          = ../../../ThirdParty/MCUXpressoSDK
DEVICE_PATH       = $(SDK_PATH)/devices/LPC55S69
FREE_RTOS_PATH    = $(SDK_PATH)/rtos/freertos/freertos-kernel
STARTUP           = $(DEVICE_PATH)/gcc/startup_LPC55S69_cm33_core0.S
LINK_SCRIPT       = ./LPC55S69_cm33_core0_flash.ld

ifeq ($(FREE_RTOS),1)
FREE_RTOS_SOURCE_PATH =                                                        \
                    $(FREE_RTOS_PATH)                                          \
                    $(FREE_RTOS_PATH)/portable/MemMang                         \
                    $(FREE_RTOS_PATH)/portable/GCC/ARM_CM33_NTZ/non_secure
endif

###############################################################################
# Include standard rules and utilities
# Include Embedded Wizard configuration and list of generated source code
###############################################################################
include ./utilities.mk
include ./rules.mk

ifeq (,$(wildcard $(EMWI_APP_PATH)/ewfiles.inc))
  $(error ERROR: $n$nThe file '(EMWI_APP_PATH)/ewfiles.inc' is missing!\
    $nPlease open Embedded Wizard project and generate code before calling make!)
endif

include $(EMWI_APP_PATH)/ewfiles.inc

EMWI_RTE_PATH     = ../../../PlatformPackage/RTE
EMWI_GFX_PATH     = ../../../PlatformPackage/$(EMWI_COLOR_FORMAT)

ifeq (,$(wildcard $(EMWI_GFX_PATH)/ewgfx.inc))
  $(error ERROR: $n$nThe requested color format $(EMWI_COLOR_FORMAT) is not supported for this platform!\
    $nPlease open Embedded Wizard project, select one of the supported color formats and generate code again)
endif

include $(EMWI_GFX_PATH)/ewgfx.inc
include $(EMWI_RTE_PATH)/ewrte.inc

###############################################################################
# Standard directories for C files
###############################################################################
vpath %.c           $(SRC_PATH)                                                \
                    $(EMWI_APP_PATH)                                           \
                    $(EMWI_RTE_PATH)                                           \
                    $(EMWI_GFX_PATH)                                           \
                    $(EMWI_BSP_PATH)                                           \
                    $(EMWI_BSP_PATH)/Drivers                                   \
                    $(DEVICE_PATH)                                             \
                    $(DEVICE_PATH)/cmsis_drivers                               \
                    $(DEVICE_PATH)/drivers                                     \
                    $(DEVICE_PATH)/utilities                                   \
                    $(DEVICE_PATH)/utilities/debug_console                     \
                    $(DEVICE_PATH)/utilities/str                               \
                    $(SDK_PATH)/components/lists                               \
                    $(SDK_PATH)/components/serial_manager                      \
                    $(SDK_PATH)/components/uart                                \
                    $(FREE_RTOS_SOURCE_PATH)

###############################################################################
# SOURCES
###############################################################################
APP_C =                                                                        \
                    main.c                                                     \
                    ewmain.c                                                   \
                    DeviceDriver.c                                             \

# automatically compile all files generated by Embedded Wizard
APP_EMWI_C =        $(EMWIFILES)

# compile all files for the Embedded Wizard Runtime Environment (RTE)
RTE_EMWI_C =        $(EMWI_RTE_FILES)

# compile all files for the Embedded Wizard Graphics Engine (GFX)
GFX_EMWI_C =        $(EMWI_GFX_FILES)

BOARD_CONFIG_C =                                                               \
                    ew_bsp_os.c                                                \
                    ew_bsp_system.c                                            \
                    ew_bsp_clock.c                                             \
                    ew_bsp_event.c                                             \
                    ew_bsp_display.c                                           \
                    ew_bsp_touch.c                                             \
                    ew_bsp_console.c                                           \
                    ew_bsp_inout.c                                             \
                    system_LPC55S69_cm33_core0.c                               \
                    board.c                                                    \
                    clock_config.c                                             \
                    fsl_ft6x06.c                                               \
                    ili9341_spi.c                                              \
                    pin_mux.c                                                  \

BSP_C =                                                                        \
                    fsl_assert.c                                               \
                    fsl_clock.c                                                \
                    fsl_common.c                                               \
                    fsl_common_arm.c                                           \
                    fsl_debug_console.c                                        \
                    fsl_gpio.c                                                 \
                    fsl_str.c                                                  \
                    fsl_i2c_cmsis.c                                            \
                    fsl_spi_cmsis.c                                            \
                    fsl_flexcomm.c                                             \
                    fsl_i2c.c                                                  \
                    fsl_inputmux.c                                             \
                    fsl_pint.c                                                 \
                    fsl_power.c                                                \
                    fsl_reset.c                                                \
                    fsl_rtc.c                                                  \
                    fsl_spi.c                                                  \
                    fsl_usart.c                                                \
                    fsl_component_serial_manager.c                             \
                    fsl_component_serial_port_uart.c                           \
                    fsl_component_generic_list.c                               \
                    fsl_adapter_usart.c

FREE_RTOS_C =                                                                  \
                    portasm.c                                                  \
                    heap_4.c                                                   \
                    croutine.c                                                 \
                    event_groups.c                                             \
                    list.c                                                     \
                    queue.c                                                    \
                    stream_buffer.c                                            \
                    tasks.c                                                    \
                    timers.c                                                   \
                    port.c                                                     \

###############################################################################
# LIBRARIES
###############################################################################
LIBS :=             m                                                          \
                    c                                                          \
                    nosys                                                      \
                    $(EMWI_GFX_LIB)                                            \
                    $(EMWI_RTE_LIB)                                            \

###############################################################################
# INCLUDES
###############################################################################
INCLUDES =                                                                     \
                    -I$(SRC_PATH)                                              \
                    -I$(EMWI_BSP_PATH)                                         \
                    -I$(EMWI_BSP_PATH)/Drivers                                 \
                    -I$(EMWI_APP_PATH)                                         \
                    -I$(EMWI_RTE_PATH)                                         \
                    -I$(EMWI_GFX_PATH)                                         \
                    -I$(SDK_PATH)/CMSIS/Core/Include                           \
                    -I$(SDK_PATH)/CMSIS/Driver/Include                         \
                    -I$(DEVICE_PATH)                                           \
                    -I$(DEVICE_PATH)/cmsis_drivers                             \
                    -I$(DEVICE_PATH)/drivers                                   \
                    -I$(DEVICE_PATH)/utilities                                 \
                    -I$(DEVICE_PATH)/utilities/str                             \
                    -I$(DEVICE_PATH)/utilities/debug_console                   \
                    -I$(SDK_PATH)/components/lists                             \
                    -I$(SDK_PATH)/components/serial_manager                    \
                    -I$(SDK_PATH)/components/uart                              \

ifeq ($(FREE_RTOS),1)
INCLUDES +=                                                                    \
                    -I$(FREE_RTOS_PATH)/include                                \
                    -I$(FREE_RTOS_PATH)/portable/GCC/ARM_CM33_NTZ/non_secure
endif

###############################################################################
# DEFINES
###############################################################################
CFLAGS =            -O2 -Wall -mcpu=cortex-m33 -mthumb                         \
                    -mthumb-interwork -mfpu=fpv5-sp-d16 -mfloat-abi=hard       \
                    -ffunction-sections -fdata-sections                        \
                    -ffreestanding                                             \
                    -fno-builtin                                               \
                    -fno-common                                                \
                    -DNDEBUG                                                   \
                    -DCPU_LPC55S69JBD100                                       \
                    -DCPU_LPC55S69JBD100_cm33                                  \
                    -DCPU_LPC55S69JBD100_cm33_core0                            \
                    -DSERIAL_PORT_TYPE_UART=1                                  \
                    -DEW_FRAME_BUFFER_COLOR_FORMAT=EW_FRAME_BUFFER_COLOR_FORMAT_$(EMWI_COLOR_FORMAT) \
                    -DEW_SURFACE_ROTATION=$(EMWI_SURFACE_ROTATION)             \
                    -DEW_USE_OPERATING_SYSTEM=$(FREE_RTOS)                     \

###############################################################################
# OBJECTS
###############################################################################
ALL_SRC    = $(APP_C) $(APP_EMWI_C) $(RTE_EMWI_C) $(GFX_EMWI_C) $(BOARD_CONFIG_C) $(BSP_C)

ifeq ($(FREE_RTOS),1)
  ALL_SRC += $(FREE_RTOS_C)
endif

OBJS      = $(foreach file,$(ALL_SRC), $(OBJ_PATH)/$(strip $(basename $(file))).o)

MAPFILE   = -Wl,-Map=$(BIN_PATH)/$(APP_FILE).map

LINKING   = $(LD) -mcpu=cortex-m33 -mlittle-endian -mthumb -mthumb-interwork   \
            -mfpu=fpv5-sp-d16 -mfloat-abi=hard -Wl,--gc-sections               \
            $(MAPFILE)                                                         \
            $(STARTUP)                                                         \
            $(OBJS)                                                            \
            $(addprefix -L,$(EMWI_RTE_PATH))                                   \
            $(addprefix -L,$(EMWI_GFX_PATH))                                   \
            $(addprefix -L,$(DEVICE_PATH)/gcc)                                 \
            $(addprefix -l,$(LIBS))                                            \
            -T $(LINK_SCRIPT)                                                  \
            -o $(BIN_PATH)/$(APP_FILE).elf

TRANSLATE = $(OBJCOPY) -O ihex $(BIN_PATH)/$(APP_FILE).elf $(BIN_PATH)/$(APP_FILE).hex

PRINT_SIZE  = $(SIZE) $(BIN_PATH)/$(APP_FILE).elf

FLASHING  = ..\..\FlashDownload\FlashDownload.cmd $(BIN_PATH)/$(APP_FILE).elf reset

###############################################################################
# RULES
###############################################################################
$(APP_FILE): precompile $(OBJS)
	@echo Linking $(APP_FILE)
	@echo $(LINKING)
	$(LINKING)
	@echo Memory Usage:
	$(PRINT_SIZE)
	$(TRANSLATE)
	@echo $(APP_FILE) successfully built !!

install: $(APP_FILE)
	$(FLASHING)

projectecho:
	@echo -------------------------------------------------
	@echo Creating $(APP_FILE)
	@echo -------------------------------------------------
	@echo Compiler Options: $(CFLAGS)

createdirs:
	@echo -------------------------------------------------
	@echo Creating object and binary directories
	-$(MKDIR) $(OBJ_PATH)
	-$(MKDIR) $(BIN_PATH)
	@echo -------------------------------------------------

precompile: projectecho createdirs ;

.PHONY: clean
clean:
	@echo Cleaning $(OBJ_PATH) and $(BIN_PATH)
	-$(RMDIR) $(OBJ_PATH)
	-$(RMDIR) $(BIN_PATH)

include $(wildcard $(patsubst %,%.d,$(basename $(OBJS))))
